---
- name: Build docker image and tag it
  hosts: server
  environment:
    KUBECONFIG: "{{ kubeconfig_dir }}"
    TEST_NETWORK_CLUSTER_RUNTIME: "{{ cluster_runtime }}"
  vars:
    test_network_chaincode_image: localhost:5000/asset-transfer-basic
  tasks:
    - name: Build external chaincode image via docker_image
      community.docker.docker_image:
        name: asset-transfer-basic
        build:
          path: "{{ ansible_user_dir }}/go/src/github.com/{{ ansible_user }}/fabric-samples/asset-transfer-basic/chaincode-external"
        source: build

    - name: Tag asset-transer-basic image
      community.docker.docker_image_tag:
        name: asset-transfer-basic
        repository:
          - "{{ test_network_chaincode_image }}"
        tag: latest

    - name: Push asset-transfer-basic image
      community.docker.docker_image_push:
        name: "{{ test_network_chaincode_image }}"

- name: Setup Hyperledger Fabric
  hosts: server
  environment:
    APPROVE_EXTRA_ARGS: "--signature-policy AND('Org1MSP.peer','Org2MSP.peer')"
    COMMIT_EXTRA_ARGS: "--signature-policy AND('Org1MSP.peer','Org2MSP.peer')"
    INVOKE_EXTRA_ARGS: "--peerAddresses org1-peer1.localho.st:443 \
      --tlsRootCertFiles $PWD/build/channel-msp/peerOrganizations/org1/msp/tlscacerts/tlsca-signcert.pem \
      --peerAddresses org2-peer1.localho.st:443 \
      --tlsRootCertFiles $PWD/build/channel-msp/peerOrganizations/org2/msp/tlscacerts/tlsca-signcert.pem"
    TEST_NETWORK_CHAINCODE_SEQUENCE: "1"
    KUBECONFIG: "{{ kubeconfig_dir }}"
    TEST_NETWORK_CLUSTER_RUNTIME: "{{ cluster_runtime }}"
  tasks:
    - name: Check network script exists
      ansible.builtin.stat:
        path: "{{ fabric_k8s_dir }}/network"
      register: _network_script_result

    - name: Shut down existing Hyperledger Fabric network
      ansible.builtin.command:
        argv:
          - ./network
          - down
        chdir: "{{ fabric_k8s_dir }}"
      when: _network_script_result.stat.exists
      changed_when: false

    - name: Copy org CA manifests
      vars:
        org_files:
          # CA files
          - { org: org0, kind: ca }
          - { org: org1, kind: ca }
          - { org: org2, kind: ca }
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/files/{{ item.org }}/{{ item.org }}-{{ item.kind }}.yaml"
        dest: "{{ fabric_k8s_dir }}/kube/{{ item.org }}/{{ item.org }}-{{ item.kind }}.yaml"
        mode: "0644"
        force: true
      loop: "{{ org_files }}"

    - name: Template peer manifests
      vars:
        org_files:
          # peer1 files
          - { org: org1, kind: peer1 }
          - { org: org2, kind: peer1 }
          # peer2 files
          - { org: org1, kind: peer2 }
          - { org: org2, kind: peer2 }
      ansible.builtin.template:
        src: "{{ playbook_dir }}/templates/{{ item.org }}/{{ item.org }}-{{ item.kind }}.yaml.j2"
        dest: "{{ fabric_k8s_dir }}/kube/{{ item.org }}/{{ item.org }}-{{ item.kind }}.yaml"
        mode: "0644"
        force: true
      loop: "{{ org_files }}"

    - name: Copy org0-orderer files
      vars:
        orderers:
          - { orderer: orderer1 }
          - { orderer: orderer2 }
          - { orderer: orderer3 }
          - { orderer: orderer4 }
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/files/org0/org0-{{ item.orderer }}.yaml"
        dest: "{{ fabric_k8s_dir }}/kube/org0/org0-{{ item.orderer }}.yaml"
        mode: preserve
      loop: "{{ orderers }}"

    - name: Copy file to scripts
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/files/chaincode.sh"
        dest: "{{ fabric_k8s_dir }}/scripts/chaincode.sh"
        mode: preserve

    - name: Initialize cluster network
      ansible.builtin.command:
        argv:
          - ./network
          - cluster
          - init
        chdir: "{{ fabric_k8s_dir }}"
      changed_when: false

    - name: Launch network
      ansible.builtin.command:
        argv:
          - ./network
          - up
        chdir: "{{ fabric_k8s_dir }}"
      changed_when: false

    - name: Create a channel
      ansible.builtin.command:
        argv:
          - ./network
          - channel
          - create
        chdir: "{{ fabric_k8s_dir }}"
      changed_when: false

    - name: Initialize ledger
      ansible.builtin.command:
        argv:
          - ./network
          - chaincode
          - deploy
          - asset-transfer-basic
          - ../asset-transfer-basic/chaincode-java
        chdir: "{{ fabric_k8s_dir }}"
      changed_when: false

    - name: Access blockchain with REST API
      ansible.builtin.command:
        argv:
          - ./network
          - rest-easy
        chdir: "{{ fabric_k8s_dir }}"
      changed_when: false

- name: Setup Hyperledger Caliper
  hosts: server
  environment:
    KUBECONFIG: "{{ kubeconfig_dir }}"
    TEST_NETWORK_CLUSTER_RUNTIME: "{{ cluster_runtime }}"
  vars:
    caliper_dir: "{{ ansible_user_dir }}/caliper-benchmarks"
  tasks:
    - name: Copy connection profiles to Caliper environment
      vars:
        profiles:
          - { org: ORG1, dest: connection-profile1.json }
          - { org: ORG2, dest: connection-profile2.json }
      ansible.builtin.copy:
        src: "{{ fabric_k8s_dir }}/build/fabric-rest-sample-config/HLF_CONNECTION_PROFILE_{{ item.org }}"
        dest: "{{ caliper_dir }}/networks/fabric/{{ item.dest }}"
        remote_src: true
        mode: preserve
      loop: "{{ profiles }}"

    - name: Patch connection profiles (domain and port)
      vars:
        profile_files:
          - connection-profile1.json
          - connection-profile2.json
        patterns:
          - { regexp: '\.test-network\.svc\.cluster\.local', replace: '.localho.st' }
      ansible.builtin.replace:
        path: "{{ caliper_dir }}/networks/fabric/{{ item.0 }}"
        regexp: "{{ item.1.regexp }}"
        replace: "{{ item.1.replace }}"
      loop: "{{ profile_files | product(patterns) | list }}"

    - name: Create test-network.yaml
      ansible.builtin.template:
        src: "{{ playbook_dir }}/templates/test-network.j2"
        dest: "{{ caliper_dir }}/networks/fabric/test-network.yaml"
        force: true
        mode: '0644'

    - name: Create workload directory
      ansible.builtin.file:
        path: "{{ caliper_dir }}/workload"
        state: directory
        mode: '0755'

    - name: Copy readAsset.js to workload directory
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/files/readAsset.js"
        dest: "{{ caliper_dir }}/workload/readAsset.js"
        mode: preserve

    - name: Copy myAssetBenchmark.yaml to benchmarks directory
      ansible.builtin.template:
        src: "{{ playbook_dir }}/templates/myAssetBenchmark.yaml.j2"
        dest: "{{ caliper_dir }}/benchmarks/myAssetBenchmark.yaml"
        mode: preserve

    - name: Port-forward org1-peer1 service to localhost:7051
      ansible.builtin.command:
        cmd: kubectl -n test-network port-forward svc/org1-peer1 7051:7051
      async: 300
      poll: 0
      changed_when: false

    - name: Run Caliper benchmark
      ansible.builtin.command:
        argv:
          - npx
          - caliper
          - launch
          - manager
          - --caliper-workspace
          - .
          - --caliper-benchconfig
          - benchmarks/myAssetBenchmark.yaml
          - --caliper-networkconfig
          - networks/fabric/test-network.yaml
        chdir: "{{ caliper_dir }}"
      register: caliper_output
      changed_when: false

    - name: Print Caliper benchmark output
      ansible.builtin.debug:
        var: caliper_output.stdout_lines

    - name: Shut down existing Hyperledger Fabric network
      ansible.builtin.command:
        argv:
          - ./network
          - down
        chdir: "{{ fabric_k8s_dir }}"
      changed_when: false
